<!doctype html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<style>
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .help{color:#6b7280}
</style>
</head><body class="bg-light">
<nav class="navbar navbar-dark">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center brand" href="/">
      <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
      <span>NC Sigma Portal</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="/documents.html">Documents</a>
      <a class="nav-link" href="/media.html">Media</a>
      <a class="nav-link" href="/chapters.html">Chapters</a>
      <a class="nav-link" href="/calendar">Calendar</a>
      <a class="nav-link active" href="/admin">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- Admin key -->
  <div class="alert alert-info d-flex align-items-center justify-content-between">
    <div>Admin actions require your key.</div>
    <input id="adminKey" type="password" class="form-control" style="max-width:280px" placeholder="Admin Key">
  </div>

  <!-- Import Chapters + EOY -->
  <div class="card mb-4">
    <div class="card-header">Import Chapters + EOY (Q4) <span class="help">(supports ?dryRun=true)</span></div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Chapters Excel</label>
          <input id="chFile" type="file" class="form-control" accept=".xls,.xlsx">
        </div>
        <div class="col-md-4">
          <label class="form-label">EOY Excel</label>
          <input id="eoyFile" type="file" class="form-control" accept=".xls,.xlsx">
        </div>
        <div class="col-md-2">
          <label class="form-label">Dry Run</label>
          <select id="dryRun" class="form-select">
            <option value="false" selected>No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="col-md-2 text-end">
          <button id="doImport" class="btn btn-primary w-100">Upload</button>
        </div>
      </div>
      <pre id="importOut" class="mt-3 mono small"></pre>
    </div>
  </div>

  <!-- Import Yearly History -->
  <div class="card mb-4">
    <div class="card-header">Import Yearly History <span class="help">(LONG or WIDE; supports ?dryRun=true)</span></div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <input id="histFile" type="file" class="form-control" accept=".xls,.xlsx">
        </div>
        <div class="col-md-3">
          <label class="form-label">Dry Run</label>
          <select id="dryRunYearly" class="form-select">
            <option value="false" selected>No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <button id="doImportYearly" class="btn btn-success w-100">Upload Yearly History</button>
        </div>
      </div>
      <pre id="histOut" class="mt-3 mono small"></pre>
    </div>
  </div>

  <!-- Chapter Profile (crest & president) -->
  <div class="card mb-4">
    <div class="card-header">Chapter Profile (Crest & President)</div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Select Chapter</label>
          <select id="profChapter" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <button id="loadProf" class="btn btn-outline-secondary w-100">Load</button>
        </div>
        <div class="col-md-6 help">
          Tip: Use the Image Uploader below to get URLs for crest and headshot.
        </div>
        <div class="col-12"><hr></div>
        <div class="col-md-6">
          <label class="form-label">Crest URL</label>
          <input id="crestUrl" type="url" class="form-control" placeholder="/uploads/chapters/crest.png or https://...">
        </div>
        <div class="col-md-6">
          <label class="form-label">President Photo URL</label>
          <input id="presPhoto" type="url" class="form-control" placeholder="/uploads/chapters/president.jpg or https://...">
        </div>
        <div class="col-md-6">
          <label class="form-label">President Name</label>
          <input id="presName" type="text" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">President Email</label>
          <input id="presEmail" type="email" class="form-control" placeholder="name@domain.com">
        </div>
        <div class="col-12 text-end">
          <button id="saveProf" class="btn btn-success">Save Profile</button>
        </div>
      </div>
      <pre id="profOut" class="mt-3 mono small"></pre>
    </div>
  </div>

  <!-- NEW: Image Uploader -->
  <div class="card mb-4">
    <div class="card-header">Image Uploader</div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Folder</label>
          <select id="imgKind" class="form-select">
            <option value="chapters">Chapters (crests, headshots)</option>
            <option value="events">Events (flyers)</option>
          </select>
        </div>
        <div class="col-md-6">
          <input id="imgFile" type="file" class="form-control" accept="image/*">
        </div>
        <div class="col-md-3 text-end">
          <button id="doUploadImage" class="btn btn-primary w-100">Upload Image</button>
        </div>
      </div>
      <div class="help mt-2">After upload, copy the URL into the Chapter Profile form above.</div>
      <pre id="imgOut" class="mt-3 mono small"></pre>
    </div>
  </div>

  <!-- NEW: Events (create minimal) -->
  <div class="card mb-4">
    <div class="card-header">Create Event (appears on Calendar & ICS)</div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Chapter</label>
          <select id="evChapter" class="form-select"></select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Title</label>
          <input id="evTitle" type="text" class="form-control" placeholder="Event title">
        </div>

        <div class="col-md-6">
          <label class="form-label">Start (local time)</label>
          <input id="evStart" type="datetime-local" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">End (optional)</label>
          <input id="evEnd" type="datetime-local" class="form-control">
        </div>

        <div class="col-md-6">
          <label class="form-label">Location</label>
          <input id="evLoc" type="text" class="form-control" placeholder="Address or venue">
        </div>
        <div class="col-md-6">
          <label class="form-label">Visibility</label>
          <select id="evVis" class="form-select">
            <option>Public</option>
            <option>Brothers</option>
            <option>Officers</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea id="evDesc" class="form-control" rows="3" placeholder="Details, agenda, links…"></textarea>
        </div>

        <div class="col-12 text-end">
          <button id="saveEvent" class="btn btn-success">Save Event</button>
        </div>
      </div>
      <pre id="evOut" class="mt-3 mono small"></pre>
    </div>
  </div>

  <!-- NEW: CSV Exports -->
  <div class="card mb-4">
    <div class="card-header">Exports</div>
    <div class="card-body d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-secondary" href="/api/export/chapters.csv">Download Chapters CSV</a>
      <a class="btn btn-outline-secondary" href="/api/export/yearly_stats.csv">Download Yearly Stats CSV</a>
      <a class="btn btn-outline-secondary" href="/calendar.ics" target="_blank">Calendar ICS</a>
    </div>
  </div>

</div>

<script>
async function loadChaptersTo(selectId){
  const res = await fetch('/api/chapters');
  const chapters = await res.json();
  const sel = document.getElementById(selectId);
  sel.innerHTML = '';
  chapters.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

// Populate dropdowns on load
loadChaptersTo('profChapter');
loadChaptersTo('evChapter');

// Import (chapters + eoy)
document.getElementById('doImport').onclick = async ()=>{
  const key = document.getElementById('adminKey').value;
  const dry = document.getElementById('dryRun').value;
  const fd = new FormData();
  const ch  = document.getElementById('chFile').files[0];
  const eoy = document.getElementById('eoyFile').files[0];
  if (!ch || !eoy) { alert('Choose both files'); return; }
  fd.append('chaptersFile', ch);
  fd.append('eoyFile', eoy);
  const res = await fetch('/api/admin/import?dryRun='+dry, { method:'POST', headers:{'x-admin-key':key}, body: fd });
  document.getElementById('importOut').textContent = JSON.stringify(await res.json(), null, 2);
};

// Import Yearly
document.getElementById('doImportYearly').onclick = async ()=>{
  const key = document.getElementById('adminKey').value;
  const dry = document.getElementById('dryRunYearly').value;
  const fd = new FormData();
  const f  = document.getElementById('histFile').files[0];
  if (!f) { alert('Choose a file'); return; }
  fd.append('historyFile', f);
  const res = await fetch('/api/admin/import-yearly?dryRun='+dry, { method:'POST', headers:{'x-admin-key':key}, body: fd });
  document.getElementById('histOut').textContent = JSON.stringify(await res.json(), null, 2);
};

// Profiles
document.getElementById('loadProf').onclick = async ()=>{
  const id = document.getElementById('profChapter').value;
  const r = await fetch(`/api/chapters/${id}/profile`);
  const p = await r.json();
  document.getElementById('crestUrl').value  = p.crest_url || '';
  document.getElementById('presPhoto').value = p.president_photo_url || '';
  document.getElementById('presName').value  = p.president_name || '';
  document.getElementById('presEmail').value = p.president_email || '';
};

document.getElementById('saveProf').onclick = async ()=>{
  const id = document.getElementById('profChapter').value;
  const key = document.getElementById('adminKey').value;
  const body = {
    crest_url: document.getElementById('crestUrl').value || null,
    president_photo_url: document.getElementById('presPhoto').value || null,
    president_name: document.getElementById('presName').value || null,
    president_email: document.getElementById('presEmail').value || null
  };
  const res = await fetch(`/api/admin/chapters/${id}/profile`, {
    method:'POST',
    headers:{'Content-Type':'application/json','x-admin-key':key},
    body: JSON.stringify(body)
  });
  document.getElementById('profOut').textContent = JSON.stringify(await res.json(), null, 2);
};

// Image upload
document.getElementById('doUploadImage').onclick = async ()=>{
  const key = document.getElementById('adminKey').value;
  const kind = document.getElementById('imgKind').value;
  const file = document.getElementById('imgFile').files[0];
  if (!file) { alert('Choose an image'); return; }
  const fd = new FormData();
  fd.append('image', file);
  const res = await fetch('/api/admin/upload-image/'+kind, { method:'POST', headers:{'x-admin-key':key}, body: fd });
  document.getElementById('imgOut').textContent = JSON.stringify(await res.json(), null, 2);
};

// Events
document.getElementById('saveEvent').onclick = async ()=>{
  const key = document.getElementById('adminKey').value;
  const body = {
    chapter_id: document.getElementById('evChapter').value,
    title:      document.getElementById('evTitle').value,
    start_utc:  new Date(document.getElementById('evStart').value).toISOString(),
    end_utc:    document.getElementById('evEnd').value ? new Date(document.getElementById('evEnd').value).toISOString() : null,
    location:   document.getElementById('evLoc').value || null,
    visibility: document.getElementById('evVis').value,
    description:document.getElementById('evDesc').value || null,
    status:     'Approved'
  };
  if (!body.title || !document.getElementById('evStart').value) { alert('Title and Start are required'); return; }
  const res = await fetch('/api/admin/events', {
    method:'POST',
    headers:{'Content-Type':'application/json','x-admin-key':key},
    body: JSON.stringify(body)
  });
  document.getElementById('evOut').textContent = JSON.stringify(await res.json(), null, 2);
};
</script>
</body></html>

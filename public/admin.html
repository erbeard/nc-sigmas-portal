<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<style>
  :root{ --royal:#0b2b7e; }
  .card h5{ margin:0; }
  .header{ background:var(--royal); color:#fff; border-radius:12px; padding:.8rem 1rem; }
  pre{ white-space:pre-wrap; }
  .flyer-thumb{ max-width:120px; max-height:120px; border-radius:8px; border:1px solid #e5e7eb; }
  .table-sm td, .table-sm th { padding:.45rem .5rem; vertical-align: middle; }
  .status-badge{ font-size:.75rem; }
</style>
</head>
<nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center justify-content-between">
      <a class="navbar-brand d-flex align-items-center brand" href="/">
        <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
        <span>NC Sigma Portal</span>
      </a>

      <ul class="navbar-nav flex-row align-items-center gap-3">
        <li class="nav-item"><a class="nav-link" href="/network.html">Network</a></li>
        <li class="nav-item"><a class="nav-link" href="/resources.html">Resources</a></li>
        <li class="nav-item"><a class="nav-link" href="/chapters.html">Chapters</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="confMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Conferences
          </a>
          <ul class="dropdown-menu" aria-labelledby="confMenu">
            <li>
              <a class="dropdown-item" href="https://www.zeffy.com/en-US/ticketing/2025-north-carolina-state-conference"
                 target="_blank" rel="noopener noreferrer">
                2025 State Conference
              </a>
            </li>
            <li>
              <span class="dropdown-item text-muted">2026 Regional Conference</span>
            </li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/calendar">Calendar</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>
      </ul>
    </div>
  </nav>

  <!-- Bootstrap JS Bundle (includes Popper for dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>

  <!-- Zeffy Script (if still needed elsewhere on the site) -->
  <script src="https://zeffy-scripts.s3.ca-central-1.amazonaws.com/embed-form-script.min.js"></script>

<div class="container py-4">
  <div class="header mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
      <div class="fs-5 fw-semibold">Admin Console</div>
      <div class="d-flex align-items-center gap-2">
        <input id="adminKey" type="password" placeholder="Admin Key" class="form-control form-control-sm" style="width:220px">
        <button class="btn btn-sm btn-light" onclick="saveKey()">Save</button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- A. Chapters (independent) -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5>Chapters Import (Independent)</h5>
          <p class="text-muted mb-2 small">Upload the <strong>North Carolina Chapters</strong> sheet. Existing chapters are kept/updated; missing ones are added.</p>
          <form id="formChaptersOnly" onsubmit="return uploadChaptersOnly(event)">
            <div class="mb-2">
              <input class="form-control" type="file" name="chaptersFile" accept=".xlsx,.xls" required>
            </div>
            <button class="btn btn-primary">Upload Chapters</button>
          </form>
          <pre id="resChaptersOnly" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

    <!-- B. EOY (independent) -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5>EOY Report Import (Independent)</h5>
          <p class="text-muted small mb-2">Upload the EOY report (sheet <i>Southeastern</i>, rows begin at A24). This writes yearly totals for existing chapters only.</p>
          <form id="formEOYOnly" onsubmit="return uploadEOYOnly(event)">
            <div class="mb-2">
              <input class="form-control" type="file" name="eoyFile" accept=".xlsx,.xls" required>
            </div>
            <button class="btn btn-primary">Upload EOY</button>
          </form>
          <pre id="resEOYOnly" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

    <!-- C. Chapter History -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5>Chapter History (Yearly)</h5>
          <p class="text-muted small mb-2">Upload either:
            <br>• <strong>LONG</strong>: Chapter | Year | Active Members
            <br>• <strong>WIDE</strong>: Chapter | 2021 | 2022 | 2023 | ...
          </p>
          <form id="formHistory" onsubmit="return uploadHistory(event)">
            <div class="mb-2">
              <input class="form-control" type="file" name="historyFile" accept=".xlsx,.xls" required>
            </div>
            <button class="btn btn-primary">Upload History</button>
          </form>
          <pre id="resHistory" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

<!-- D. PIA -->
<div class="col-lg-6">
  <div class="card">
    <div class="card-body">
      <h5>PIA Import</h5>
      <p class="text-muted small mb-2">
        Upload the BluPrint export (headers typically on row 3). This will import
        date, year, hours and flags into <code>pia_entries</code>.
      </p>

      <form id="formPIA" onsubmit="return uploadPIA(event)">
        <div class="mb-2">
          <!-- important: use name="file" -->
          <input class="form-control" id="piaFile" name="file" type="file" accept=".xlsx,.xls" required>
        </div>
        <button class="btn btn-primary">Upload PIA</button>
      </form>
      <pre id="resPIA" class="mt-2 small"></pre>
    </div>
  </div>
</div>

    <!-- E. Roster Import -->
<div class="col-lg-6">
  <div class="card">
    <div class="card-body">
      <h5>Roster Import (Full Roster Excel)</h5>
      <p class="text-muted small mb-2">
        Columns expected: <strong>Chapter</strong>, <strong>First Name</strong>, <strong>Last Name</strong>,
        <strong>Member Number</strong>, <strong>Initiated date</strong>, <strong>Years Paid</strong>, (optional) <strong>Status</strong>.
        “Financial Through” is computed from the last year in “Years Paid” (e.g., <code>23,24,25</code> → <code>2025</code>).
      </p>
      <form id="formRoster" onsubmit="return uploadRoster(event)">
        <div class="mb-2">
          <input class="form-control" type="file" name="rosterFile" accept=".xlsx,.xls" required>
        </div>
        <button class="btn btn-primary">Upload Roster</button>
      </form>
      <pre id="resRoster" class="mt-2 small"></pre>
    </div>
  </div>
</div>

<!-- Alumni Roster CSV (Independent) -->
<div class="col-lg-6">
  <div class="card">
    <div class="card-body">
      <h5>Alumni Roster Import (CSV)</h5>
      <p class="text-muted small mb-2">
        Upload the CSV export (headers like <code>Member #</code>, <code>Full Name</code>, <code>Email</code>,
        <code>Affiliated Chapter</code>, <code>Career Field</code>, <code>Military Affiliation</code>, <code>Active Duty</code>, etc.).
        Members are upserted by <strong>Member #</strong>.
      </p>
      <form id="formAlumni" onsubmit="return uploadAlumni(event)">
        <div class="mb-2">
          <input class="form-control" type="file" name="alumniFile" accept=".csv" required>
        </div>
        <button class="btn btn-primary">Upload Alumni CSV</button>
      </form>
      <pre id="resAlumni" class="mt-2 small"></pre>
    </div>
  </div>
</div>

    <!-- F. Chapter Profile -->
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h5>Chapter Profile (Crest & President)</h5>
          <p class="text-muted small mb-2">Select a chapter and save crest/president details. Use full URLs for images (S3, etc.).</p>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Chapter</label>
              <select id="cpChapter" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Crest URL</label>
              <input id="cpCrest" class="form-control" placeholder="https://.../crest.png">
            </div>
            <div class="col-md-4">
              <label class="form-label">President Photo URL</label>
              <input id="cpPhoto" class="form-control" placeholder="https://.../photo.jpg">
            </div>
            <div class="col-md-6">
              <label class="form-label">President Name</label>
              <input id="cpName" class="form-control" placeholder="First Last">
            </div>
            <div class="col-md-6">
              <label class="form-label">President Email</label>
              <input id="cpEmail" class="form-control" placeholder="name@domain.com">
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
          </div>
          <pre id="resProfile" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

    <hr class="mt-4">
<h5>Advisors</h5>
<p class="text-muted small mb-2">Add a chapter advisor (multiple allowed). Photos may be full URLs.</p>

<div class="row g-3 align-items-end">
  <div class="col-md-4">
    <label class="form-label">Advisor Name</label>
    <input id="advName" class="form-control" placeholder="First Last">
  </div>
  <div class="col-md-3">
    <label class="form-label">Advisor Email</label>
    <input id="advEmail" class="form-control" placeholder="name@domain.com">
  </div>
  <div class="col-md-3">
    <label class="form-label">Advisor Phone</label>
    <input id="advPhone" class="form-control" placeholder="(###) ###-####">
  </div>
  <div class="col-md-2">
    <label class="form-label">Photo URL</label>
    <input id="advPhoto" class="form-control" placeholder="https://.../photo.jpg">
  </div>
  <div class="col-12">
    <button class="btn btn-primary" onclick="addAdvisor()">Add Advisor</button>
  </div>
</div>

<div class="mt-3">
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr><th>Advisor</th><th>Email / Phone</th><th>Photo</th><th style="width:1%"></th></tr>
      </thead>
      <tbody id="advisorRows"><tr><td colspan="4" class="text-muted">Select a chapter to load advisors…</td></tr></tbody>
    </table>
  </div>
</div>
<pre id="resAdvisors" class="mt-2 small"></pre>

    <!-- G. Resources Upload (Local file OR Link) -->
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h5>Resources Upload (Branding, Collegiate, Alumni, Programs, Bylaws & International)</h5>
          <p class="text-muted small mb-2">Upload a local file <em>or</em> save a link (S3/Drive/etc). Choose the section where it should appear.</p>

          <!-- Mode toggle -->
          <div class="mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="modeFile" value="file" checked>
              <label class="form-check-label" for="modeFile">Upload File</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="mode" id="modeLink" value="link">
              <label class="form-check-label" for="modeLink">Use Link</label>
            </div>
          </div>

          <form id="formDoc">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Title</label>
                <input class="form-control" name="title" required placeholder="e.g., NC Brand Guide 2025">
              </div>
              <div class="col-md-3">
                <label class="form-label">Group</label>
                <select class="form-select" name="group" required>
                  <option value="">Select…</option>
                  <option value="Branding">Branding</option>
                  <option value="Collegiate">Collegiate</option>
                  <option value="Alumni">Alumni</option>
                  <option value="BBB">BBB</option>
                  <option value="Social Action">Social Action</option>
                  <option value="Education">Education</option>
                  <option value="SBC">Sigma Beta Club</option>
                  <option value="Bylaws & International">Bylaws & International Documentation</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Type</label>
                <input class="form-control" name="doc_type" placeholder="Guide, Template, Logo, PDF…">
              </div>
              <div class="col-md-2">
                <label class="form-label">Publish Date</label>
                <input class="form-control" name="publish_date" type="date">
              </div>

              <!-- File mode -->
              <div class="col-md-8" id="fileRow">
                <label class="form-label">Choose File</label>
                <input class="form-control" type="file" name="file" />
                <div class="form-text">Accepted: any file (served from this server under /uploads/resources/...)</div>
              </div>

              <!-- Link mode -->
              <div class="col-md-8 d-none" id="linkRow">
                <label class="form-label">File URL</label>
                <input class="form-control" name="file_url" placeholder="https://...">
              </div>

              <div class="col-md-2">
                <label class="form-label">Visibility</label>
                <select class="form-select" name="visibility">
                  <option value="public" selected>public</option>
                  <option value="members">members</option>
                  <option value="private">private</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Tags</label>
                <input class="form-control" name="tags" placeholder="comma,separated">
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" onclick="return saveResource(event)">Save Resource</button>
            </div>
          </form>

          <pre id="resDoc" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

<!-- I. Manage Resources -->
<div class="col-lg-12">
  <div class="card">
    <div class="card-body">
      <h5>Manage Resources</h5>
      <div class="d-flex gap-2 align-items-center mb-2">
        <input id="docSearch" class="form-control form-control-sm" placeholder="Search title, type, tags…" style="max-width:320px">
        <select id="docGroup" class="form-select form-select-sm" style="max-width:220px">
          <option value="">All Groups</option>
          <option value="Branding">Branding</option>
          <option value="Collegiate">Collegiate</option>
          <option value="Alumni">Alumni</option>
          <option value="BBB">BBB</option>
          <option value="Social Action">Social Action</option>
          <option value="Education">Education</option>
          <option value="SBC">Sigma Beta Club</option>
          <option value="Bylaws & International">Bylaws & International Documentation</option>
        </select>
        <button class="btn btn-outline-primary btn-sm" onclick="loadDocs()">Refresh</button>
        <span id="docCount" class="small text-muted ms-auto">—</span>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px">Title</th>
              <th>Group</th>
              <th>Type</th>
              <th>Tags</th>
              <th>Publish Date</th>
              <th style="width:1%"></th>
            </tr>
          </thead>
          <tbody id="docsBody">
            <tr><td colspan="6" class="text-muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <pre id="resDocs" class="mt-2 small"></pre>
    </div>
  </div>
</div>

    <!-- H. Calendar Approvals -->
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h5>Calendar Approvals</h5>
          <p class="text-muted small mb-2">Review pending program submissions. Approvals appear immediately on the public calendar.</p>

          <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-primary btn-sm" onclick="loadPending()">Refresh</button>
            <span id="pendingCount" class="badge text-bg-secondary align-self-center">0 pending</span>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Program</th>
                  <th>Chapter</th>
                  <th>Date/Time</th>
                  <th>Location</th>
                  <th>Flyer</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingBody">
                <tr><td colspan="6" class="text-muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <pre id="resCalendar" class="mt-2 small"></pre>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
function getKey(){ return localStorage.getItem('adminKey') || ''; }
function saveKey(){
  const v = document.getElementById('adminKey').value.trim();
  localStorage.setItem('adminKey', v);
  alert('Admin key saved in this browser.');
}
document.getElementById('adminKey').value = getKey();

/* Load chapters into profile selector */
async function loadChapters(){
  const sel = document.getElementById('cpChapter');
  if (!sel) return;
  sel.innerHTML = '<option value="">Loading…</option>';
  const rows = await (await fetch('/api/chapters')).json();
  sel.innerHTML = '<option value="">Select a chapter…</option>' + rows.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
}
loadChapters();

/* Upload handlers (independent) */
async function uploadChaptersOnly(e){
  e.preventDefault();
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const fd = new FormData(document.getElementById('formChaptersOnly'));
  const res = await fetch('/api/admin/chapters/import', {
    method:'POST',
    headers:{ 'x-admin-key': key },
    body: fd
  });
  const out = await res.json();
  document.getElementById('resChaptersOnly').textContent = JSON.stringify(out, null, 2);
  if (res.ok) loadChapters();
  return false;
}

async function uploadEOYOnly(e){
  e.preventDefault();
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const fd = new FormData(document.getElementById('formEOYOnly'));
  const res = await fetch('/api/admin/eoy/import', {
    method:'POST',
    headers:{ 'x-admin-key': key },
    body: fd
  });
  const out = await res.json();
  document.getElementById('resEOYOnly').textContent = JSON.stringify(out, null, 2);
  return false;
}

async function uploadHistory(e){
  e.preventDefault();
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const fd = new FormData(document.getElementById('formHistory'));
  const res = await fetch('/api/admin/history/import', {
    method:'POST',
    headers:{ 'x-admin-key': key },
    body: fd
  });
  const out = await res.json();
  document.getElementById('resHistory').textContent = JSON.stringify(out, null, 2);
  return false;
}

async function uploadAlumni(e){
  e.preventDefault();
  const key = getKey();
  if (!key) { alert('Enter admin key and click Save.'); return false; }

  const form = document.getElementById('formAlumni');
  const file = form.querySelector('input[name="alumniFile"]').files[0];
  if (!file) { alert('Choose a CSV file'); return false; }

  const fd = new FormData(form);

  let res, bodyText = '', out;
  try {
    res = await fetch('/api/admin/alumni/import', {
      method: 'POST',
      headers: { 'x-admin-key': key }, // DO NOT set Content-Type for FormData
      body: fd
    });

    const ct = (res.headers.get('content-type')||'').toLowerCase();
    if (ct.includes('application/json')) {
      out = await res.json();
    } else {
      bodyText = await res.text();
      try { out = JSON.parse(bodyText); } catch { out = { raw: bodyText }; }
    }

    const debug = {
      ok: res.ok,
      status: res.status,
      statusText: res.statusText,
      headers: Object.fromEntries([...res.headers.entries()]),
      response: out
    };
    document.getElementById('resAlumni').textContent = JSON.stringify(debug, null, 2);

    if (!res.ok) {
      alert(out?.error || `Upload failed (${res.status})`);
    } else {
      alert('Alumni CSV upload completed.');
    }
  } catch (err) {
    document.getElementById('resAlumni').textContent = `Network/JS error: ${err?.message||err}`;
    alert('Upload could not be completed (see details below).');
  }
  return false;
}

/* ---------- PIA UPLOAD (fixed + extra fields) ---------- */
async function uploadPIA(e){
  e.preventDefault();
  const key = getKey(); if (!key) { alert('Enter admin key and click Save.'); return false; }

  const fileInput = document.getElementById('piaFile');
  const file = fileInput.files[0];
  if (!file) { alert('Choose a file'); return false; }

  const fd = new FormData();
  // Primary name most servers expect:
  fd.append('file', file);
  // Backward-compat: if your server used to look for 'piaFile', this covers it.
  fd.append('piaFile', file);

  const res = await fetch('/api/admin/pia/import', {
    method:'POST',
    headers: { 'x-admin-key': key },  // DO NOT set Content-Type when sending FormData
    body: fd
  });

  const ct = (res.headers.get('content-type') || '').toLowerCase();
  let outStr = '';
  try {
    if (ct.includes('application/json')) {
      const json = await res.json();
      outStr = JSON.stringify(json, null, 2);
    } else {
      // Show raw text/HTML so you can see the server error message
      outStr = await res.text();
    }
  } catch {
    outStr = 'Server returned a non-JSON response (and could not be parsed).';
  }

  document.getElementById('resPIA').textContent = outStr;

  if (!res.ok) {
    // keep the text in the pre block, but also alert quickly
    alert('PIA upload failed. See details below.');
  }
  return false;
}

async function uploadRoster(e){
    e.preventDefault();
    const key = getKey(); 
    if (!key) { alert('Enter admin key and click Save.'); return false; }

    const fd = new FormData(document.getElementById('formRoster'));
    const res = await fetch('/api/admin/roster/import', {
      method: 'POST',
      headers: { 'x-admin-key': key },
      body: fd
    });

    let out;
    try { out = await res.json(); }
    catch { out = { error: 'Server returned a non-JSON response.' }; }

    document.getElementById('resRoster').textContent = JSON.stringify(out, null, 2);

    if (!res.ok) {
      alert(out?.error || 'Roster upload failed.');
    }
    return false;
  }

/* Save Chapter Profile */
async function saveProfile(){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const payload = {
    chapter_id: document.getElementById('cpChapter').value || null,
    crest_url: document.getElementById('cpCrest').value || null,
    president_name: document.getElementById('cpName').value || null,
    president_email: document.getElementById('cpEmail').value || null,
    president_photo_url: document.getElementById('cpPhoto').value || null
  };
  if (!payload.chapter_id) return alert('Select a chapter');

  const res = await fetch('/api/admin/chapter-profile', {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-admin-key': key
    },
    body: JSON.stringify(payload)
  });
  const out = await res.json();
  document.getElementById('resProfile').textContent = JSON.stringify(out, null, 2);
}

/* Toggle between File and Link mode */
const modeFile = document.getElementById('modeFile');
const modeLink = document.getElementById('modeLink');
const fileRow = document.getElementById('fileRow');
const linkRow = document.getElementById('linkRow');

function refreshMode(){
  const isFile = modeFile.checked;
  fileRow.classList.toggle('d-none', !isFile);
  linkRow.classList.toggle('d-none', isFile);
}
modeFile.addEventListener('change', refreshMode);
modeLink.addEventListener('change', refreshMode);
refreshMode();

/* Save Resource: file OR link */
async function saveResource(e){
  e.preventDefault();
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const form = document.getElementById('formDoc');

  const common = {
    title: form.title.value.trim(),
    group: form.group.value.trim(),
    doc_type: form.doc_type.value.trim() || '',
    publish_date: form.publish_date.value || '',
    visibility: form.visibility.value || 'public',
    tags: form.tags.value.trim() || ''
  };
  if (!common.title || !common.group){
    return alert('Please provide Title and Group.');
  }

  let res, out;
  if (modeFile.checked){
    const fd = new FormData();
    Object.entries(common).forEach(([k,v])=> fd.append(k, v));
    const file = form.file.files[0];
    if (!file) return alert('Choose a file to upload.');
    fd.append('file', file);

    res = await fetch('/api/admin/documents/upload', {
      method:'POST',
      headers: { 'x-admin-key': key },
      body: fd
    });
    out = await res.json();
  } else {
    const payload = { ...common, file_url: form.file_url.value.trim() };
    if (!payload.file_url) return alert('Paste a File URL.');
    res = await fetch('/api/admin/documents/upsert', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-admin-key': key
      },
      body: JSON.stringify(payload)
    });
    out = await res.json();
  }

  document.getElementById('resDoc').textContent = JSON.stringify(out, null, 2);
  return false;
}

async function loadAdvisors(){
  const cid = document.getElementById('cpChapter').value;
  const tb = document.getElementById('advisorRows');
  if (!cid){ tb.innerHTML = '<tr><td colspan="4" class="text-muted">Select a chapter...</td></tr>'; return; }
  try{
    const rows = await (await fetch(`/api/chapters/${cid}/advisors`)).json();
    if (!Array.isArray(rows) || rows.length===0){
      tb.innerHTML = '<tr><td colspan="4" class="text-muted">No advisors on file.</td></tr>';
      return;
    }
    tb.innerHTML = '';
    rows.forEach(a=>{
      const tr = document.createElement('tr');
      const photo = (a.photo_url && a.photo_url.trim()) ? a.photo_url.trim() : '/img/avatar-placeholder.png';
      tr.innerHTML = `
        <td class="fw-semibold">${a.name||'—'}</td>
        <td class="small">${a.email?`<a href="mailto:${a.email}">${a.email}</a>`:'—'}${a.phone?` • ${a.phone}`:''}</td>
        <td><img src="${photo}" alt="" style="width:44px;height:44px;border-radius:50%;object-fit:cover" onerror="this.src='/img/avatar-placeholder.png'"></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteAdvisor('${a.id||''}')">Remove</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML = '<tr><td colspan="4" class="text-danger">Failed to load advisors.</td></tr>';
  }
}

// Add advisor
async function addAdvisor(){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const cid = document.getElementById('cpChapter').value;
  if (!cid) return alert('Select a chapter');
  const payload = {
    chapter_id: cid,
    name: document.getElementById('advName').value.trim(),
    email: document.getElementById('advEmail').value.trim(),
    phone: document.getElementById('advPhone').value.trim(),
    photo_url: document.getElementById('advPhoto').value.trim()
  };
  if (!payload.name) return alert('Advisor name is required');

  const res = await fetch('/api/admin/advisors/upsert', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-admin-key': key },
    body: JSON.stringify(payload)
  });
  const out = await res.json().catch(()=>({}));
  document.getElementById('resAdvisors').textContent = JSON.stringify(out, null, 2);
  if (res.ok){
    document.getElementById('advName').value='';
    document.getElementById('advEmail').value='';
    document.getElementById('advPhone').value='';
    document.getElementById('advPhoto').value='';
    loadAdvisors();
  } else {
    alert(out?.error || 'Failed to add advisor');
  }
}

// Delete advisor
async function deleteAdvisor(id){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  if (!confirm('Remove this advisor?')) return;
  const res = await fetch('/api/admin/advisors/delete', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-admin-key': key },
    body: JSON.stringify({ id })
  });
  const out = await res.json().catch(()=>({}));
  document.getElementById('resAdvisors').textContent = JSON.stringify(out, null, 2);
  if (res.ok) loadAdvisors();
}

// When chapter dropdown changes, also refresh advisors
const cpSel = document.getElementById('cpChapter');
if (cpSel){
  cpSel.addEventListener('change', ()=>{ loadAdvisors(); });
}

/* --------- Calendar Approvals UI ---------- */
function fmtDT(dt){
  const d = new Date(dt);
  if (isNaN(d)) return dt;
  const date = d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
  const time = d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
  return `${date} • ${time}`;
}

function flyerCell(url){
  if (!url) return '<span class="text-muted">—</span>';
  if (/\.(png|jpg|jpeg|gif)$/i.test(url)){
    return `<img class="flyer-thumb" src="${url}" alt="Flyer">`;
  }
  return `<a href="${url}" target="_blank" rel="noopener">Open</a>`;
}

async function loadPending(){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const res = await fetch('/api/admin/calendar/pending', { headers: { 'x-admin-key': key }});
  const rows = await res.json().catch(()=>[]);
  const tb = document.getElementById('pendingBody');
  tb.innerHTML = '';
  if (!rows.length){
    tb.innerHTML = '<tr><td colspan="6" class="text-muted">No pending events.</td></tr>';
  } else {
    rows.forEach(r=>{
      const start = r.start_iso ? fmtDT(r.start_iso) : '—';
      const end   = r.end_iso ? ' – ' + fmtDT(r.end_iso) : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="fw-semibold">${r.title||'—'}</div>
          <div class="small text-muted">${r.description||''}</div>
        </td>
        <td>${r.chapter_name || '—'}</td>
        <td>${start}${end}</td>
        <td>${r.location || '—'}</td>
        <td>${flyerCell(r.flyer_url)}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-success btn-sm" onclick="approveEvent('${r.id}')">Approve</button>
            <button class="btn btn-outline-danger btn-sm" onclick="rejectEvent('${r.id}')">Reject</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }
  document.getElementById('pendingCount').textContent = `${rows.length} pending`;
}

async function approveEvent(id){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const res = await fetch('/api/admin/calendar/approve', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'x-admin-key': key },
    body: JSON.stringify({ id })
  });
  const out = await res.json();
  document.getElementById('resCalendar').textContent = JSON.stringify(out, null, 2);
  loadPending();
}

async function rejectEvent(id){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  const res = await fetch('/api/admin/calendar/reject', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'x-admin-key': key },
    body: JSON.stringify({ id })
  });
  const out = await res.json();
  document.getElementById('resCalendar').textContent = JSON.stringify(out, null, 2);
  loadPending();
}

let __allDocs = [];

function fmtDateShort(iso){
  if (!iso) return '—';
  const d = new Date(iso); if (isNaN(d)) return '—';
  return d.toLocaleDateString();
}

function renderDocs(){
  const q = (document.getElementById('docSearch').value || '').toLowerCase();
  const g = (document.getElementById('docGroup').value || '').toLowerCase();
  const tb = document.getElementById('docsBody');

  const rows = __allDocs.filter(d=>{
    const inGroup = !g || (String(d.group||'').toLowerCase() === g);
    if (!inGroup) return false;
    const hay = [
      d.title, d.doc_type, d.tags, d.group
    ].map(v=>String(v||'').toLowerCase()).join(' ');
    return !q || hay.includes(q);
  });

  document.getElementById('docCount').textContent = `${rows.length} result${rows.length===1?'':'s'}`;

  if (!rows.length){
    tb.innerHTML = '<tr><td colspan="6" class="text-muted">No resources found.</td></tr>';
    return;
  }

  tb.innerHTML = '';
  rows
    .sort((a,b)=> (b.publish_date||'').localeCompare(a.publish_date||''))
    .forEach(d=>{
      const tr = document.createElement('tr');
      const href = d.file_url || '#';
      tr.innerHTML = `
        <td>
          <div class="fw-semibold"><a href="${href}" target="_blank" rel="noopener">${d.title || 'Untitled'}</a></div>
          <div class="small text-muted">${d.id ? `ID: ${d.id}` : ''}</div>
        </td>
        <td>${d.group || '—'}</td>
        <td>${d.doc_type || '—'}</td>
        <td>${d.tags || '—'}</td>
        <td>${fmtDateShort(d.publish_date)}</td>
        <td class="text-end">
          <button class="btn btn-outline-danger btn-sm" onclick="deleteDoc('${d.id||''}')">Delete</button>
        </td>
      `;
      tb.appendChild(tr);
    });
}

async function loadDocs(){
  try{
    const res = await fetch('/api/documents');
    __allDocs = await res.json();
  }catch{
    __allDocs = [];
  }
  renderDocs();
}

async function deleteDoc(id){
  const key = getKey(); if (!key) return alert('Enter admin key and click Save.');
  if (!id) return alert('Missing document id.');
  if (!confirm('Delete this resource? This cannot be undone.')) return;

  // If your backend uses a different path, adjust here:
  const res = await fetch('/api/admin/documents/delete', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-admin-key': key },
    body: JSON.stringify({ id })
  });

  const ct = (res.headers.get('content-type')||'').toLowerCase();
  const out = ct.includes('json') ? await res.json() : await res.text();
  document.getElementById('resDocs').textContent =
    typeof out === 'string' ? out : JSON.stringify(out, null, 2);

  if (res.ok){
    // remove locally & re-render
    __allDocs = __allDocs.filter(d => String(d.id) !== String(id));
    renderDocs();
  } else {
    alert((out && out.error) || 'Delete failed.');
  }
}

// live search
document.addEventListener('input', (e)=>{
  if (e.target && (e.target.id === 'docSearch' || e.target.id === 'docGroup')){
    renderDocs();
  }
});

// initial load
loadDocs();

loadPending();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calendar • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;900&display=swap" rel="stylesheet">
<style>
  :root{ --royal:#0b2b7e; }
  #calendar{ max-width: 1100px; margin: 0 auto; background:#fff; border-radius:12px; padding:10px }
  .fc .fc-toolbar-title{ font-weight:800; color:var(--royal); }
  .event-card img{ max-width:100%; border-radius:8px }
</style>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center brand" href="/">
      <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
      <span>NC Sigma Portal</span>
    </a>

    <ul class="navbar-nav flex-row align-items-center gap-3">
      <li class="nav-item"><a class="nav-link" href="/resources.html">Resources</a></li>
      <li class="nav-item"><a class="nav-link" href="/chapters.html">Chapters</a></li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="/conferences/2025.html" id="confMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          Conferences
        </a>
        <ul class="dropdown-menu" aria-labelledby="confMenu">
          <li><a class="dropdown-item" href="/conferences/2025.html">2025 State Conference</a></li>
          <li><a class="dropdown-item" href="/conferences/2026.html">2026 Regional Conference</a></li>
        </ul>
      </li>
      <li class="nav-item"><a class="nav-link" href="/calendar">Calendar</a></li>
      <li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>
    </ul>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">State Calendar</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitModal">Submit an Event</button>
  </div>

  <div id="calendar"></div>

  <!-- Event Modal (when clicking an event) -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="evtTitle" class="modal-title"></h5>
          <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body event-card">
          <div class="mb-2"><strong>Date/Time: </strong><span id="evtWhen">—</span></div>
          <div class="mb-2"><strong>Chapter: </strong><span id="evtChapter">—</span></div>
          <div class="mb-2"><strong>Location: </strong><span id="evtLocation">—</span></div>
          <div class="mb-2"><strong>Description: </strong><div id="evtDesc" class="mt-1"></div></div>
          <div id="evtFlyerWrap" class="mt-3" style="display:none;">
            <div class="mb-1"><strong>Flyer</strong></div>
            <img id="evtFlyer" src="" alt="Flyer">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form id="submitForm" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Submit a Program</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Submissions are reviewed and must be approved before appearing on the calendar.</p>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Chapter (optional)</label>
              <select name="chapter_id" id="chapterSelect" class="form-select">
                <option value="">— Not listed / General —</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Program Name *</label>
              <input class="form-control" name="title" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date *</label>
              <input type="date" class="form-control" name="date" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Start Time *</label>
              <input type="time" class="form-control" name="start_time" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">End Time</label>
              <input type="time" class="form-control" name="end_time">
            </div>
            <div class="col-md-12">
              <label class="form-label">Location</label>
              <input class="form-control" name="location" placeholder="Venue or address">
            </div>
            <div class="col-md-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3" placeholder="Details about the program"></textarea>
            </div>
            <div class="col-md-12">
              <label class="form-label">Flyer (optional)</label>
              <input type="file" class="form-control" name="flyer" accept=".jpg,.jpeg,.png,.gif,.pdf">
              <div class="form-text">Images (JPG/PNG/GIF) recommended. PDFs will be linked.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div id="submitMsg" class="me-auto small text-muted"></div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Submit for Approval</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
function fmtDT(dt){
  // dt ISO string; render local readable
  const d = new Date(dt);
  if (isNaN(d)) return dt;
  const date = d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
  const time = d.toLocaleTimeString(undefined,{hour:'numeric',minute:'2-digit'});
  return date + ' • ' + time;
}

async function loadChapters(){
  const sel = document.getElementById('chapterSelect');
  const rows = await (await fetch('/api/chapters')).json();
  rows.sort((a,b)=>a.name.localeCompare(b.name))
      .forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.name;
        sel.appendChild(opt);
      });
}

function initCalendar(){
  const el = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',
    height: 'auto',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: {
      url: '/api/calendar/events',
      method: 'GET'
    },
    eventClick: function(info){
      const e = info.event;
      const x = e.extendedProps || {};
      document.getElementById('evtTitle').textContent = e.title || 'Program';
      document.getElementById('evtWhen').textContent = fmtDT(e.startStr) + (e.endStr ? ' – ' + fmtDT(e.endStr) : '');
      document.getElementById('evtChapter').textContent = x.chapter_name || '—';
      document.getElementById('evtLocation').textContent = x.location || '—';
      document.getElementById('evtDesc').textContent = x.description || '—';
      const flyerWrap = document.getElementById('evtFlyerWrap');
      const flyer = document.getElementById('evtFlyer');
      if (x.flyer_url && /\.(png|jpg|jpeg|gif)$/i.test(x.flyer_url)){
        flyer.src = x.flyer_url;
        flyerWrap.style.display = '';
      } else {
        flyerWrap.style.display = 'none';
        flyer.src = '';
      }
      const modal = new bootstrap.Modal(document.getElementById('eventModal'));
      modal.show();
    }
  });
  calendar.render();
}

async function submitEvent(e){
  e.preventDefault();
  const form = document.getElementById('submitForm');
  const fd = new FormData(form);
  const res = await fetch('/api/calendar/submit', { method:'POST', body: fd });
  const out = await res.json().catch(()=> ({}));
  const msg = document.getElementById('submitMsg');
  if (!res.ok){
    msg.textContent = out.error || 'Submission failed.';
    msg.className = 'me-auto small text-danger';
    return false;
  }
  msg.textContent = 'Submitted! Your event will appear after approval.';
  msg.className = 'me-auto small text-success';
  form.reset();
  return false;
}

document.getElementById('submitForm').addEventListener('submit', submitEvent);
loadChapters();
initCalendar();
</script>
</body>
</html>

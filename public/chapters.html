<!doctype html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chapters • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<style>
  #map{height:52vh}
  .chip{display:inline-block;padding:.25rem .5rem;border-radius:9999px;font-size:.875rem;margin-right:.5rem;cursor:pointer;user-select:none}
  .chip-collegiate{background:#e7f1ff;border:1px solid #93c5fd;color:#0b2b7e}
  .chip-alumni{background:#fff1f0;border:1px solid #fca5a5;color:#b91c1c}
  .chip-inactive{background:#f3f4f6;border:1px solid #d1d5db;color:#374151}
  .chip-selected{box-shadow:0 0 0 2px rgba(0,0,0,.05) inset; filter:saturate(1.2)}
  .chapter-link{display:block;padding:.5rem .75rem;border-bottom:1px solid #eee;text-decoration:none;color:#0b2b7e}
  .chapter-link:hover{background:#f8fafc}
  .badge-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.5rem;vertical-align:middle}
  .dot-collegiate{background:#2563EB}
  .dot-alumni{background:#DC2626}
  .dot-inactive{background:#6B7280}
  .table-sm td, .table-sm th { padding: .35rem .5rem; }
</style>
</head><body class="bg-light">
<nav class="navbar navbar-dark">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center brand" href="/">
      <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
      <span>NC Sigma Portal</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="/documents.html">Documents</a>
      <a class="nav-link" href="/media.html">Media</a>
      <a class="nav-link active" href="/chapters.html">Chapters</a>
      <a class="nav-link" href="/calendar">Calendar</a>
      <a class="nav-link" href="/admin">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row g-3 align-items-center mb-2">
    <div class="col-12">
      <h3 class="mb-2">Chapters</h3>
      <div id="kpis" class="mb-2">
        <span id="k-total" class="chip"       role="button" tabindex="0">Active: 0</span>
        <span id="k-collegiate" class="chip chip-collegiate" role="button" tabindex="0">Collegiate: 0</span>
        <span id="k-alumni" class="chip chip-alumni"         role="button" tabindex="0">Alumni: 0</span>
        <span id="k-inactive" class="chip chip-inactive"     role="button" tabindex="0">Inactive: 0</span>
      </div>
      <small class="text-muted">Click a chip to filter, and click again to clear.</small>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left: search + list -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <div class="d-flex align-items-center gap-2">
            <span>Chapter List</span>
          </div>
        </div>
        <div class="p-2">
          <input id="chapterSearch" class="form-control" placeholder="Search chapters by name or city…">
        </div>
        <div class="list-group list-group-flush" id="chapterList" style="max-height:78vh;overflow:auto;"></div>
      </div>
    </div>

    <!-- Right: totals + map + lists -->
    <div class="col-lg-8">
      <!-- Totals card -->
      <div class="card mb-2">
        <div class="card-body d-flex flex-wrap gap-4">
          <div>
            <div class="text-muted small">Total Brothers</div>
            <div id="t-total" class="h4 mb-0">—</div>
            <div id="t-date" class="small text-muted">as of —</div>
          </div>
          <div>
            <div class="text-muted small">Total Alumni</div>
            <div id="t-alumni" class="h4 mb-0">—</div>
          </div>
          <div>
            <div class="text-muted small">Total Collegiate</div>
            <div id="t-collegiate" class="h4 mb-0">—</div>
          </div>
        </div>
      </div>

      <!-- Map -->
      <div id="map" class="rounded border mb-3"></div>
      <div class="mb-3">
        <span class="chip"><span class="badge-dot dot-collegiate"></span>Collegiate</span>
        <span class="chip"><span class="badge-dot dot-alumni"></span>Alumni</span>
        <span class="chip"><span class="badge-dot dot-inactive"></span>Inactive</span>
      </div>

      <!-- Top 5 by membership -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Top 5 by Membership</span>
          <small class="text-muted" id="tmYear">—</small>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mini mb-1 fw-semibold">Collegiate</div>
              <table class="table table-sm">
                <tbody id="tmCollegiate"></tbody>
              </table>
            </div>
            <div class="col-md-6">
              <div class="mini mb-1 fw-semibold">Alumni</div>
              <table class="table table-sm">
                <tbody id="tmAlumni"></tbody>
              </table>
            </div>
          </div>
          <div class="small text-muted">Click a name to open the chapter page.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let map, markers=[], allChapters=[], filter = null;
const BLUE_ICON_URL = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'; // blue pins

function setChipSelected(id, on){ document.getElementById(id).classList.toggle('chip-selected', on); }
function clearChipSelections(){ ['k-total','k-collegiate','k-alumni','k-inactive'].forEach(id=>setChipSelected(id,false)); }

function passesFilter(c){
  if (!filter) return true;
  const status = (c.status||'Active').toLowerCase();
  const type   = (c.type||'').toLowerCase();
  if (filter==='active')     return status==='active';
  if (filter==='collegiate') return status==='active' && type==='collegiate';
  if (filter==='alumni')     return status==='active' && type==='alumni';
  if (filter==='inactive')   return status!=='active';
  return true;
}

function renderList(chapters){
  const ul = document.getElementById('chapterList');
  ul.innerHTML = '';
  chapters.filter(passesFilter).sort((a,b)=>a.name.localeCompare(b.name)).forEach(c=>{
    const a = document.createElement('a');
    a.href = `/chapter/${c.id}`;
    a.className = 'chapter-link';
    const isActive = (c.status||'Active').toLowerCase()==='active';
    const type = (c.type||'').toLowerCase();
    const dotClass = isActive ? (type==='collegiate' ? 'dot-collegiate' : 'dot-alumni') : 'dot-inactive';
    a.innerHTML = `<span class="badge-dot ${dotClass}"></span>${c.name}${c.city? ' <small class="text-muted">— '+c.city+'</small>':''}`;
    ul.appendChild(a);
  });
}

function renderMap(chapters){
  // clear old markers
  markers.forEach(m=>m.setMap(null)); markers = [];
  const bounds = new google.maps.LatLngBounds(); let any=false;

  chapters
    .filter(c=>c.latitude && c.longitude)
    .filter(passesFilter)
    .forEach(c=>{
      const m = new google.maps.Marker({
        map,
        position:{ lat:c.latitude, lng:c.longitude },
        title:c.name,
        icon: { url: BLUE_ICON_URL }
      });
      const html = `<div style="min-width:200px"><strong>${c.name}</strong><br/>${c.city? c.city+'<br/>':''}<a href="/chapter/${c.id}">Open chapter page</a></div>`;
      const inf = new google.maps.InfoWindow({ content: html });
      m.addListener('click', ()=> inf.open({ map, anchor: m }));
      markers.push(m);
      bounds.extend(m.getPosition()); any=true;
    });

  if (any) map.fitBounds(bounds);
}

function applyFilter(newFilter){
  filter = (filter===newFilter) ? null : newFilter;
  clearChipSelections();
  if (filter==='active')     setChipSelected('k-total', true);
  if (filter==='collegiate') setChipSelected('k-collegiate', true);
  if (filter==='alumni')     setChipSelected('k-alumni', true);
  if (filter==='inactive')   setChipSelected('k-inactive', true);
  renderList(allChapters); renderMap(allChapters);
}

async function loadTotals(){
  const t = await (await fetch('/api/stats/active-brothers/by-type-latest')).json();
  const fmt = (n)=> (n==null ? '—' : n.toLocaleString());
  document.getElementById('t-total').textContent = fmt(t.total);
  document.getElementById('t-alumni').textContent = fmt(t.alumni);
  document.getElementById('t-collegiate').textContent = fmt(t.collegiate);
  document.getElementById('t-date').textContent = t.year ? ('as of ' + t.year) : 'as of —';
}

function renderTopMembership(targetId, list){
  const el = document.getElementById(targetId);
  el.innerHTML = '';
  list.forEach((r, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="text-muted">${i+1}.</td>
      <td><a href="/chapter/${r.id}">${r.name}</a></td>
      <td class="text-end">${(r.members??0).toLocaleString()}</td>`;
    el.appendChild(tr);
  });
}

async function loadTop5(){
  const [mCol, mAlu] = await Promise.all([
    fetch('/api/stats/top-membership?type=collegiate').then(r=>r.json()),
    fetch('/api/stats/top-membership?type=alumni').then(r=>r.json())
  ]);
  document.getElementById('tmYear').textContent = mCol.year ? `as of ${mCol.year}` : '—';
  renderTopMembership('tmCollegiate', mCol.rows || []);
  renderTopMembership('tmAlumni', mAlu.rows || []);
}

function applySearch(){
  const q = document.getElementById('chapterSearch').value.toLowerCase().trim();
  if (!q) { renderList(allChapters); renderMap(allChapters); return; }
  const filtered = allChapters.filter(c =>
    (c.name||'').toLowerCase().includes(q) || (c.city||'').toLowerCase().includes(q)
  );
  renderList(filtered); renderMap(filtered);
}

async function init(){
  const res = await fetch('/api/chapters');
  allChapters = await res.json();

  // KPI counts
  const active = allChapters.filter(c => (c.status||'Active').toLowerCase()==='active');
  const inactive = allChapters.length - active.length;
  const activeCollegiate = active.filter(c => (c.type||'').toLowerCase()==='collegiate').length;
  const activeAlumni = active.filter(c => (c.type||'').toLowerCase()==='alumni').length;
  document.getElementById('k-total').textContent = `Active: ${active.length}`;
  document.getElementById('k-collegiate').textContent = `Collegiate: ${activeCollegiate}`;
  document.getElementById('k-alumni').textContent = `Alumni: ${activeAlumni}`;
  document.getElementById('k-inactive').textContent = `Inactive: ${inactive}`;

  // Filters
  document.getElementById('k-total').onclick      = ()=>applyFilter('active');
  document.getElementById('k-collegiate').onclick = ()=>applyFilter('collegiate');
  document.getElementById('k-alumni').onclick     = ()=>applyFilter('alumni');
  document.getElementById('k-inactive').onclick   = ()=>applyFilter('inactive');

  // Search
  document.getElementById('chapterSearch').addEventListener('input', applySearch);

  // Map + list
  map = new google.maps.Map(document.getElementById('map'), { zoom:7, center:{lat:35.5,lng:-79}, mapTypeControl:false });
  renderList(allChapters);
  renderMap(allChapters);

  // Totals + Top5
  await loadTotals();
  await loadTop5();
}
window.init = init;
</script>

<!-- Replace YOUR_API_KEY -->
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnFyHYTnW1fDGlFZWaf1HFsc1Zjui3U7U&callback=init"></script>
</body></html>

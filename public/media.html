<!doctype html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Media • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<style>
  .album{transition:.15s all; cursor:pointer}
  .album:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.08)}
  .album .thumb{width:100%; height:160px; object-fit:cover; border-top-left-radius:.5rem; border-top-right-radius:.5rem; background:#f3f4f6}
  .album .title{font-weight:600}
  .album .meta{color:#6b7280; font-size:.85rem}
</style>
</head><body class="bg-light">
<nav class="navbar navbar-dark">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center brand" href="/">
      <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
      <span>NC Sigma Portal</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="/documents.html">Documents</a>
      <a class="nav-link" href="/media.html">Media</a>
      <a class="nav-link" href="/chapters.html">Chapters</a>
      <a class="nav-link" href="/admin">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex align-items-end gap-2 flex-wrap mb-3">
    <div class="flex-grow-1">
      <label class="form-label mb-1">Search</label>
      <input id="q" type="text" class="form-control" placeholder="Title, category, notes…">
    </div>
    <div>
      <label class="form-label mb-1">Category</label>
      <input id="cat" type="text" class="form-control" placeholder="(e.g., Conference, Service)">
    </div>
    <div>
      <label class="form-label mb-1">Year</label>
      <select id="year" class="form-select"></select>
    </div>
    <div>
      <label class="form-label mb-1">Sort</label>
      <select id="sort" class="form-select">
        <option value="date_desc">Newest</option>
        <option value="date_asc">Oldest</option>
        <option value="title_asc">Title A–Z</option>
        <option value="title_desc">Title Z–A</option>
      </select>
    </div>
    <div>
      <button id="clear" class="btn btn-outline-secondary">Clear</button>
    </div>
  </div>

  <div id="empty" class="alert alert-light border d-none">No media found.</div>
  <div id="grid" class="row g-3"></div>
</div>

<script>
let allMedia = [];

function norm(s){ return (s||'').toString().toLowerCase(); }
function yearFromDate(s){
  if(!s) return '';
  const d = new Date(s);
  return isNaN(d) ? '' : d.getFullYear().toString();
}
function fillYearFilter(){
  const sel = document.getElementById('year');
  sel.innerHTML = '<option value="">Any</option>';
  const years = Array.from(new Set(allMedia.map(m => yearFromDate(m.event_date)).filter(Boolean))).sort().reverse();
  years.forEach(y=>{
    const opt = document.createElement('option'); opt.value=y; opt.textContent=y;
    sel.appendChild(opt);
  });
}

function applyFilters(){
  const q = norm(document.getElementById('q').value);
  const cat = norm(document.getElementById('cat').value);
  const year = document.getElementById('year').value;
  const sort = document.getElementById('sort').value;

  let rows = allMedia.filter(m=>{
    const inQ = !q || [m.title, m.category, m.notes].some(x=> norm(x).includes(q));
    const inC = !cat || norm(m.category).includes(cat);
    const inY = !year || yearFromDate(m.event_date) === year;
    return inQ && inC && inY;
  });

  rows.sort((a,b)=>{
    if (sort==='date_desc') return (b.event_date||'').localeCompare(a.event_date||'');
    if (sort==='date_asc')  return (a.event_date||'').localeCompare(b.event_date||'');
    if (sort==='title_asc') return (a.title||'').localeCompare(b.title||'');
    if (sort==='title_desc')return (b.title||'').localeCompare(a.title||'');
    return 0;
  });

  render(rows);
}

function render(rows){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  document.getElementById('empty').classList.toggle('d-none', rows.length>0);

  rows.forEach(m=>{
    const col = document.createElement('div');
    col.className = 'col-sm-6 col-lg-4';
    const link = document.createElement('a');
    link.className = 'card album text-decoration-none text-reset';
    link.href = m.album_url || '#';
    link.target = '_blank';
    link.rel = 'noopener';
    link.innerHTML = `
      <img class="thumb" src="${m.thumbnail_url || '/img/placeholder.png'}" alt="">
      <div class="card-body">
        <div class="title mb-1">${m.title || '(Untitled)'}</div>
        <div class="meta">${m.category || '—'} ${m.event_date ? ' • ' + new Date(m.event_date).toISOString().slice(0,10) : ''}</div>
        ${m.notes ? `<div class="mt-2 small text-muted">${m.notes}</div>` : ''}
      </div>`;
    col.appendChild(link);
    grid.appendChild(col);
  });
}

async function init(){
  const res = await fetch('/api/media');
  allMedia = await res.json();

  fillYearFilter();
  applyFilters();

  ['q','cat','year','sort'].forEach(id=>{
    document.getElementById(id).addEventListener('input', applyFilters);
    document.getElementById(id).addEventListener('change', applyFilters);
  });
  document.getElementById('clear').onclick = ()=>{
    document.getElementById('q').value='';
    document.getElementById('cat').value='';
    document.getElementById('year').value='';
    document.getElementById('sort').value='date_desc';
    applyFilters();
  };
}
init();
</script>
</body></html>

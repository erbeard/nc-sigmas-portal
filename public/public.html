<!doctype html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calendar • NC Sigma Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/styles/site.css">
<style>
  .month{margin-top:1rem}
  .evt{border-left:4px solid #0b2b7e;background:#fff;padding:.75rem;border-radius:.5rem;margin:.4rem 0}
  .evt .when{color:#374151;font-weight:600}
  .evt .meta{color:#6b7280}
</style>
</head><body class="bg-light">
<nav class="navbar navbar-dark">
  <div class="container d-flex align-items-center justify-content-between">
    <a class="navbar-brand d-flex align-items-center brand" href="/">
      <img src="/img/nc-crest.png" alt="NC Crest" onerror="this.style.display='none'">
      <span>NC Sigma Portal</span>
    </a>
    <div class="navbar-nav">
      <a class="nav-link" href="/documents.html">Documents</a>
      <a class="nav-link" href="/media.html">Media</a>
      <a class="nav-link" href="/chapters.html">Chapters</a>
      <a class="nav-link" href="/calendar">Calendar</a>
      <a class="nav-link" href="/admin">Admin</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h3 class="mb-0">Calendar</h3>
    <a class="btn btn-outline-primary btn-sm" href="/calendar.ics" target="_blank">Subscribe via ICS</a>
  </div>

  <div class="row g-3 align-items-end mb-2">
    <div class="col-md-4">
      <label class="form-label mb-1">Visibility</label>
      <select id="vis" class="form-select">
        <option>Public</option>
        <option>Brothers</option>
        <option>Officers</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label mb-1">From</label>
      <input id="from" type="date" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label mb-1">To</label>
      <input id="to" type="date" class="form-control">
    </div>
  </div>

  <div id="empty" class="alert alert-light border d-none">No events found.</div>
  <div id="out"></div>
</div>

<script>
function fmtDateTime(s){
  if(!s) return '';
  const d = new Date(s);
  if (isNaN(d)) return s;
  return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function yyyymm(d){ return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0'); }
function monthTitle(d){ return d.toLocaleString([], { month:'long', year:'numeric' }); }

function groupByMonth(rows){
  const map = new Map();
  rows.forEach(e=>{
    const d = new Date(e.start_utc);
    const key = yyyymm(d);
    if (!map.has(key)) map.set(key, { date:d, items:[] });
    map.get(key).items.push(e);
  });
  // sort by month
  return Array.from(map.values()).sort((a,b)=> a.date - b.date);
}

function render(rows){
  const out = document.getElementById('out');
  out.innerHTML = '';
  document.getElementById('empty').classList.toggle('d-none', rows.length>0);

  const groups = groupByMonth(rows);
  groups.forEach(g=>{
    const sec = document.createElement('section');
    sec.className='month';
    sec.innerHTML = `<h5 class="mb-2">${monthTitle(g.date)}</h5>`;
    g.items.forEach(e=>{
      const a = document.createElement('div');
      a.className = 'evt shadow-sm';
      a.innerHTML = `
        <div class="when">${fmtDateTime(e.start_utc)}${e.end_utc ? ' – ' + fmtDateTime(e.end_utc) : ''}</div>
        <div class="fw-semibold">${e.title}</div>
        <div class="meta">${e.chapter_name || ''}${e.location ? ' • ' + e.location : ''}</div>
        ${e.description ? `<div class="small text-muted mt-1">${e.description}</div>`:''}
      `;
      sec.appendChild(a);
    });
    out.appendChild(sec);
  });
}

async function load(){
  const vis = document.getElementById('vis').value;
  const from = document.getElementById('from').value;
  const to   = document.getElementById('to').value;
  const qs = new URLSearchParams({ visibility: vis, status:'Approved' });
  if (from) qs.set('from', from);
  if (to) qs.set('to', to);
  const res = await fetch('/api/events?'+qs.toString());
  const rows = await res.json();
  render(rows);
}

(function init(){
  // default range: today → +180 days
  const today = new Date();
  const to = new Date(); to.setDate(today.getDate()+180);
  document.getElementById('from').value = today.toISOString().slice(0,10);
  document.getElementById('to').value   = to.toISOString().slice(0,10);

  ['vis','from','to'].forEach(id=>{
    document.getElementById(id).addEventListener('change', load);
  });

  load();
})();
</script>
</body></html>
